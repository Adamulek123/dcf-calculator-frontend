<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Price Estimator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    
    const firebaseConfig = {
        apiKey: "AIzaSyAuu1xiRsjARyIGNZyjHna9HsCqhrbPb74",
        authDomain: "dcf123-b6cb1.firebaseapp.com",
        projectId: "dcf123-b6cb1",
        storageBucket: "dcf123-b6cb1.firebasestorage.app",
        messagingSenderId: "274138479558",
        appId: "1:274138479558:web:403e8f3f3c44bd754ed0c7",
        measurementId: "G-FTJT1KSKL4"
    };

    
    try {
        window.firebaseApp = initializeApp(firebaseConfig);
        window.auth = getAuth(window.firebaseApp);
        console.log("Firebase initialized successfully.");
    } catch (e) {
        console.error("Error initializing Firebase:", e);
        window.auth = null;
    }
</script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: #212529;
            overflow-x: hidden;
        }

        .container, .insights-page-container {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 1200px;
            border: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            gap: 2.5rem;
            transition: all 0.3s ease-in-out;
        }

        @media (min-width: 1024px) {
            .container {
                flex-direction: row;
            }
        }

        .left-panel, .right-panel {
            flex: 1;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 1rem;
            min-height: 0;
        }

        .header-section {
            background-color: #ffffff;
            padding: 1.25rem 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            border: 1px solid #dee2e6;
        }

        .header-top-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1.25rem;
            width: 100%;
        }

        .header-section input {
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            color: #495057;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            flex-grow: 1;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .header-section input:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
            outline: none;
        }

        .period-toggle {
            display: flex;
            background-color: #e9ecef;
            border-radius: 0.75rem;
            padding: 0.25rem;
        }
        .period-toggle button {
            padding: 0.5rem 1rem;
            border: none;
            background: none;
            color: #6c757d;
            cursor: pointer;
            font-weight: 600;
            border-radius: 0.6rem;
            transition: all 0.2s;
        }
        .period-toggle button.active {
            background-color: #ffffff;
            color: #007bff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .period-toggle button:disabled {
            color: #adb5bd;
            cursor: not-allowed;
        }

        .primary-button {
            background-image: linear-gradient(to right, #007bff, #0056b3);
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none;
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .primary-button:hover:not(:disabled) {
            background-image: linear-gradient(to right, #0056b3, #004085);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 123, 255, 0.4);
        }
        .primary-button:active:not(:disabled) {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.2);
        }
        .primary-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            background-image: linear-gradient(to right, #6c757d, #5a6268);
        }

        .primary-button.bg-red-600 { background-image: linear-gradient(to right, #dc3545, #c82333); box-shadow: 0 6px 15px rgba(220, 53, 69, 0.4); }
        .primary-button.bg-red-600:hover:not(:disabled) { background-image: linear-gradient(to right, #c82333, #bd2130); box-shadow: 0 8px 20px rgba(220, 53, 69, 0.5); }
        .primary-button.bg-gray-600 { background-image: linear-gradient(to right, #6c757d, #5a6268); box-shadow: 0 6px 15px rgba(108, 117, 125, 0.4); }
        .primary-button.bg-gray-600:hover:not(:disabled) { background-image: linear-gradient(to right, #5a6268, #495057); box-shadow: 0 8px 20px rgba(108, 117, 125, 0.5); }
        .primary-button.bg-green-600 { background-image: linear-gradient(to right, #28a745, #218838); box-shadow: 0 6px 15px rgba(40, 167, 69, 0.4); }
        .primary-button.bg-green-600:hover:not(:disabled) { background-image: linear-gradient(to right, #218838, #1e7e34); box-shadow: 0 8px 20px rgba(40, 167, 69, 0.5); }
        .primary-button.bg-indigo-600 { background-image: linear-gradient(to right, #6610f2, #560bad); box-shadow: 0 6px 15px rgba(102, 16, 242, 0.4); }
        .primary-button.bg-indigo-600:hover:not(:disabled) { background-image: linear-gradient(to right, #560bad, #480994); box-shadow: 0 8px 20px rgba(102, 16, 242, 0.5); }
        .primary-button.bg-orange-500 { background-image: linear-gradient(to right, #fd7e14, #e86a04); box-shadow: 0 6px 15px rgba(253, 126, 20, 0.4); }
        .primary-button.bg-orange-500:hover:not(:disabled) { background-image: linear-gradient(to right, #e86a04, #d95f02); box-shadow: 0 8px 20px rgba(253, 126, 20, 0.5); }

        .company-info {
            display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem; padding: 1.5rem; background-color: #ffffff; border-radius: 1rem; border: 1px solid #dee2e6; justify-content: space-between; flex-wrap: wrap; transition: opacity 0.4s ease-in-out, height 0.4s ease-in-out, margin-bottom 0.4s ease-in-out, padding 0.4s ease-in-out; min-height: 90px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); }
        .company-info.hidden-state { opacity: 0; visibility: hidden; height: 0; margin-bottom: 0; padding-top: 0; padding-bottom: 0; min-height: 0; }
        .company-logo { font-size: 2.8rem; font-weight: bold; color: #007bff; background-color: #e9ecef; border-radius: 50%; width: 70px; height: 70px; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        .company-name { font-size: 1.75rem; font-weight: 700; color: #212529; }
        .current-price { font-size: 2.2rem; font-weight: 800; color: #28a745; }

        .tab-buttons { display: flex; margin-top: 1.75rem; margin-bottom: 1.75rem; border-bottom: 2px solid #dee2e6; }
        .tab-button { padding: 0.85rem 1.75rem; border: none; background: none; color: #6c757d; cursor: pointer; font-weight: 600; transition: color 0.2s, border-bottom 0.2s; font-size: 1.05rem; }
        .tab-button.active { color: #007bff; border-bottom: 3px solid #007bff; }
        .tab-button:hover:not(.active) { color: #495057; }

        .section-title { font-size: 1.5rem; font-weight: 700; color: #212529; margin-bottom: 1.5rem; text-align: center; }
        
        .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1.25rem; margin-bottom: 2.5rem; text-align: center; }
        .metric-item { background-color: #f8f9fa; padding: 1.25rem; border-radius: 0.85rem; border: 1px solid #e9ecef; }
        .metric-label { font-size: 0.95rem; color: #6c757d; margin-bottom: 0.4rem; font-weight: 500; }
        .metric-value { font-size: 1.4rem; font-weight: 700; color: #212529; }

        .input-group { display: flex; flex-direction: column; margin-bottom: 1.75rem; }
        .input-group label { font-size: 1.05rem; color: #212529; font-weight: 500; margin-bottom: 0.6rem; text-align: left; }
        .input-field-wrapper { display: flex; align-items: center; background-color: #f8f9fa; border: 1px solid #ced4da; border-radius: 0.75rem; padding: 0.6rem 1rem; transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .input-field-wrapper:focus-within { border-color: #80bdff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
            outline: none;
        }
        .input-field-wrapper input { color: #495057; background: none; border: none; outline: none; flex-grow: 1; padding: 0; -moz-appearance: textfield; }
        .input-field-wrapper input::-webkit-outer-spin-button, .input-field-wrapper input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .input-field-wrapper .currency-symbol, .input-field-wrapper .percentage-symbol { color: #6c757d; font-size: 1.05rem; padding-right: 0.6rem; }
        
        .login-container, .main-menu { background-color: #ffffff; padding: 3rem; border-radius: 1.5rem; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); width: 100%; max-width: 450px; border: 1px solid #dee2e6; display: flex; flex-direction: column; gap: 1.75rem; align-items: center; transition: all 0.3s ease-in-out; }
        .login-container h2, .main-menu h2 { color: #212529; font-weight: 700; }
        .login-message { font-size: 1.05rem; font-weight: 500; text-align: center; margin-top: 1.25rem; }
        
        .hidden { display: none !important; }

        .saved-calculations-list { background-color: #f8f9fa; padding: 1.5rem; border-radius: 1rem; border: 1px solid #e9ecef; }
        .saved-calculations-list h3 { font-size: 1.35rem; font-weight: 700; color: #212529; margin-bottom: 1.25rem; text-align: center; }
        .saved-calculation-item { display: flex; justify-content: space-between; align-items: center; padding: 0.85rem 0; border-bottom: 1px solid #dee2e6; font-size: 1rem; }
        .saved-calculation-item:last-child { border-bottom: none; }
        .saved-calculation-item span { color: #495057; font-weight: 500; }
        .saved-calculation-item button { padding: 0.4rem 0.8rem; border-radius: 0.4rem; font-size: 0.9rem; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background-color: #ffffff; color: #212529; padding: 2.5rem; border-radius: 1.25rem; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); text-align: center; max-width: 450px; width: 90%; border: 1px solid #dee2e6; }
        .modal-content h3 { font-size: 1.8rem; margin-bottom: 1.25rem; font-weight: 700; }
        .modal-content p { color: #6c757d; margin-bottom: 2rem; font-size: 1.1rem; }
        .modal-buttons { display: flex; justify-content: center; gap: 1.25rem; }
        .modal-buttons button { padding: 0.8rem 1.8rem; border-radius: 0.6rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        .modal-buttons .confirm-btn { background-color: #dc3545; color: white; }
        .modal-buttons .confirm-btn:hover { background-color: #c82333; transform: translateY(-2px); }
        .modal-buttons .cancel-btn { background-color: #6c757d; color: white; }
        .modal-buttons .cancel-btn:hover { background-color: #5a6268; transform: translateY(-2px); }

        .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .chart-card { background-color: #ffffff; border: 1px solid #dee2e6; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .chart-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); }
        .chart-card h3 { text-align: center; font-weight: 600; margin-bottom: 1rem; color: #495057; }

        #fullscreen-chart-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.95); z-index: 1000; display: flex; justify-content: center; align-items: center; padding: 2rem; backdrop-filter: blur(5px); }
        #fullscreen-chart-container { width: 90%; height: 90%; max-width: 1600px; max-height: 900px; }
        #close-fullscreen-btn { position: absolute; top: 2rem; right: 2rem; font-size: 2rem; background: none; border: none; color: #212529; cursor: pointer; }

        
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1002; 
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none; 
        }

        .toast {
            background-color: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: translateX(100%);
            animation: slideIn 0.3s forwards, fadeOut 0.5s forwards 2.5s; 
            min-width: 250px;
            max-width: 350px;
            font-size: 1rem;
            line-height: 1.4;
            pointer-events: auto; 
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.success {
            background-color: #28a745;
        }

        .toast.error {
            background-color: #dc3545;
        }

        .toast-icon {
            font-size: 1.5rem;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        
        .google-sign-in-button {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #4285f4; 
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            border: none;
            box-shadow: 0 6px 15px rgba(66, 133, 244, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            width: 100%; 
            gap: 10px; 
        }

        .google-sign-in-button:hover {
            background-color: #357ae8; 
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(66, 133, 244, 0.4);
        }

        .google-sign-in-button:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 5px rgba(66, 133, 244, 0.2);
        }

        .google-icon {
            width: 20px; 
            height: 20px;
            vertical-align: middle;
        }

    </style>
</head>
<body>
    <div id="mainMenu" class="main-menu hidden">
        <h2>Welcome!</h2>
        <button id="dcfCalculatorMenuBtn" class="primary-button">DCF Calculator</button>
        <button id="insightsMenuBtn" class="primary-button">Insights</button>
        <button id="logoutMenuBtn" class="primary-button bg-red-600">Logout</button>
    </div>

    <div id="loginPage" class="login-container">
        <h2>Login to DCF Calculator</h2>
        <div class="input-group w-full"><label for="loginEmail">Email</label><div class="input-field-wrapper"><input type="email" id="loginEmail" placeholder="Enter your email"></div></div>
        <div class="input-group w-full"><label for="loginPassword">Password</label><div class="input-field-wrapper"><input type="password" id="loginPassword" placeholder="Enter your password"></div></div>
        <button id="loginBtn" class="primary-button w-full">Login</button>
        <button id="googleLoginBtn" class="google-sign-in-button">
            <img src="https://upload.wikimedia.org/wikipedia/commons/d/dc/Google-g-icon.png" alt="Google logo" class="google-icon">
            Sign in with Google
        </button>
        <p class="text-gray-600 mt-4">Don't have an account? <button id="showRegisterBtn" class="text-blue-500 hover:underline font-semibold">Register</button></p>
    </div>

    <div id="registerPage" class="login-container hidden">
        <h2>Register for DCF Calculator</h2>
        <div class="input-group w-full"><label for="registerEmail">Email</label><div class="input-field-wrapper"><input type="email" id="registerEmail" placeholder="Enter your email"></div></div>
        <div class="input-group w-full"><label for="registerPassword">Password</label><div class="input-field-wrapper"><input type="password" id="registerPassword" placeholder="Choose a password"></div></div>
        <button id="registerBtn" class="primary-button w-full">Register</button>
        <p class="text-gray-600 mt-4">Already have an account? <button id="showLoginBtn" class="text-blue-500 hover:underline font-semibold">Login</button></p>
    </div>

    <div id="appContent" class="container hidden">
        <div class="left-panel">
            <div class="header-section" style="flex-direction: row;">
                <input type="text" id="tickerInput" placeholder="Enter Ticker (e.g., GOOG)">
                <button id="getCurrentDataBtn" class="primary-button">Search</button>
                <button id="backToMenuBtn" class="primary-button bg-gray-600">Menu</button>
            </div>
            <div class="tab-buttons">
                <button id="earningsTabBtn" class="tab-button active">Earnings</button>
                <button id="cashFlowTabBtn" class="tab-button">Cash Flow</button>
            </div>
            <div id="earningsSection">
                <h2 class="section-title">Assumptions (Earnings)</h2>
                <div class="metric-grid">
                    <div class="metric-item"><p class="metric-label">EPS (TTM)</p><p id="currentEps" class="metric-value">$0.00</p></div>
                    <div class="metric-item"><p class="metric-label">PE (TTM)</p><p id="currentPe" class="metric-value">0.00</p></div>
                    <div class="metric-item"><p class="metric-label">EPS Growth</p><p id="epsGrowth" class="metric-value">0.0%</p></div>
                </div>
                <div class="input-group"><label for="epsTtmInput">EPS (TTM)</label><div class="input-field-wrapper"><span class="currency-symbol">$</span><input type="number" id="epsTtmInput" value="0.00" step="0.01" readonly></div></div>
                <div class="input-group"><label for="growthRateInput">EPS Growth Rate</label><div class="input-field-wrapper"><input type="number" id="growthRateInput" placeholder="e.g., 15" step="0.1"><span class="percentage-symbol">%</span></div></div>
                <div class="input-group"><label for="peMultipleInput">Appropriate PE Multiple</label><div class="input-field-wrapper"><input type="number" id="peMultipleInput" placeholder="e.g., 20" step="0.1"></div></div>
            </div>
            <div id="cashFlowSection" class="hidden">
                <h2 class="section-title">Assumptions (Cash Flow)</h2>
                <div class="metric-grid">
                    <div class="metric-item"><p class="metric-label">FCF/Share (TTM)</p><p id="currentFcfShare" class="metric-value">$0.00</p></div>
                    <div class="metric-item"><p class="metric-label">FCF Yield (TTM)</p><p id="fcfYield" class="metric-value">0.0%</p></div>
                    <div class="metric-item"><p class="metric-label">SBC Impact</p><p id="sbcImpact" class="metric-value">0.0%</p></div>
                </div>
                <div class="input-group"><label for="fcfShareInput">FCF/Share (TTM)</label><div class="input-field-wrapper"><span class="currency-symbol">$</span><input type="number" id="fcfShareInput" value="0.00" step="0.01" readonly></div></div>
                <div class="input-group"><label for="fcfGrowthRateInput">FCF Growth Rate</label><div class="input-field-wrapper"><input type="number" id="fcfGrowthRateInput" placeholder="e.g., 12" step="0.1"><span class="percentage-symbol">%</span></div></div>
                <div class="input-group"><label for="fcfYieldInput">Appropriate FCF Yield</label><div class="input-field-wrapper"><input type="number" id="fcfYieldInput" placeholder="e.g., 5" step="0.1"><span class="percentage-symbol">%</span></div></div>
            </div>
            <div class="input-group"><label for="desiredReturnInput">Desired Return</label><div class="input-field-wrapper"><input type="number" id="desiredReturnInput" placeholder="e.g., 10" step="0.1"><span class="percentage-symbol">%</span></div></div>
            <div class="button-group mt-4">
                <button id="calculatePriceBtn" class="primary-button">Calculate</button>
                <button id="saveCalculationBtn" class="primary-button bg-green-600">Save</button>
            </div>
        </div>
        <div class="right-panel">
            <div id="companyInfo" class="company-info hidden-state">
                <div class="company-logo" id="companyLogo"></div>
                <div><p id="companyName" class="company-name"></p></div>
                <p id="currentStockPrice" class="current-price"></p>
            </div>

            <div id="projectionPlaceholder" class="text-center p-8 bg-gray-50 rounded-lg border">
                <h3 class="text-xl font-semibold text-gray-700">5-Year Projection</h3>
                <p class="mt-2 text-gray-500">Enter a stock ticker and your assumptions, then click "Calculate" to see the projected stock price and potential returns.</p>
            </div>
        
            <div id="projectionOutput" class="hidden">
                <h2 class="section-title">5-Year Projection</h2>
                <div id="calculationResults" class="p-4 bg-gray-50 rounded-lg border">
                    <p class="flex justify-between p-2 border-b">Return from today: <strong id="returnFromTodayDisplay" class="text-green-600">N/A</strong></p>
                    <p class="flex justify-between p-2 border-b">Entry Price for Desired Return: <strong id="entryPriceDisplay" class="text-green-600">N/A</strong></p>
                    <p class="flex justify-between p-2 border-b">Desired Return: <strong id="desiredReturnDisplay" class="text-green-600">N/A</strong></p>
                    <p class="flex justify-between p-2">Price After 5 Years: <strong id="priceAfter5YearsDisplay" class="text-green-600">N/A</strong></p>
                </div>
                <div class="chart-container mt-6" style="position: relative; height:300px">
                    <canvas id="priceChart"></canvas>
                </div>
                <div id="calculationMessage" class="mt-4 text-center text-gray-500"></div>
            </div>
            
            <div class="saved-calculations-list mt-8">
                <h3>Saved Calculations</h3>
                <div id="savedCalculationsContainer"><p class="text-gray-500 text-center">No saved calculations yet.</p></div>
                <button id="loadCalculationsBtn" class="primary-button mt-4 w-full bg-indigo-600">Load</button>
            </div>
        </div>
    </div>

    <div id="insightsPage" class="insights-page-container hidden">
        <div class="header-section">
            <div class="header-top-row">
                <input type="text" id="insightsTickerInput" placeholder="Enter Ticker (e.g., GOOGL)">
                <button id="getInsightsBtn" class="primary-button">Get Insights</button>
                <button id="insightsBackToMenuBtn" class="primary-button bg-gray-600">Menu</button>
            </div>
            <div class="period-toggle">
                <button id="annualToggleBtn" class="active">Annual</button>
                <button id="quarterlyToggleBtn">Quarterly</button>
            </div>
        </div>
        <div class="insights-grid" id="insightsGrid"></div>
    </div>

    <div id="fullscreen-chart-modal" class="hidden">
        <button id="close-fullscreen-btn">&times;</button>
        <div id="fullscreen-chart-container"><canvas id="fullscreen-canvas"></canvas></div>
    </div>

    <div id="confirmationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modalTitle">Confirm Action</h3>
            <p id="modalMessage">Are you sure?</p>
            <div class="modal-buttons">
                <button id="confirmYesBtn" class="confirm-btn">Yes</button>
                <button id="confirmNoBtn" class="cancel-btn">No</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script type="module">
        
        import { signInWithEmailAndPassword, createUserWithEmailAndPassword, sendEmailVerification, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        
        window.addEventListener('DOMContentLoaded', () => {
            
            const auth = window.auth; 

            const backendBaseUrl = 'https://dcf-backend.onrender.com';

            
            const mainMenu = document.getElementById('mainMenu');
            const loginPage = document.getElementById('loginPage');
            const registerPage = document.getElementById('registerPage');
            const appContent = document.getElementById('appContent');
            const insightsPage = document.getElementById('insightsPage');

            
            const dcfCalculatorMenuBtn = document.getElementById('dcfCalculatorMenuBtn');
            const insightsMenuBtn = document.getElementById('insightsMenuBtn');
            const logoutMenuBtn = document.getElementById('logoutMenuBtn');
            const backToMenuBtn = document.getElementById('backToMenuBtn');
            const insightsBackToMenuBtn = document.getElementById('insightsBackToMenuBtn');
            const showRegisterBtn = document.getElementById('showRegisterBtn');
            const showLoginBtn = document.getElementById('showLoginBtn');
            
            
            const loginEmailInput = document.getElementById('loginEmail'); // Changed to Email
            const loginPasswordInput = document.getElementById('loginPassword');
            const loginBtn = document.getElementById('loginBtn');
            const googleLoginBtn = document.getElementById('googleLoginBtn'); // New Google Login Button
            const registerEmailInput = document.getElementById('registerEmail'); // Changed to Email
            const registerPasswordInput = document.getElementById('registerPassword');
            const registerBtn = document.getElementById('registerBtn');

            
            const insightsTickerInput = document.getElementById('insightsTickerInput');
            const getInsightsBtn = document.getElementById('getInsightsBtn');
            const insightsGrid = document.getElementById('insightsGrid');
            const annualToggleBtn = document.getElementById('annualToggleBtn');
            const quarterlyToggleBtn = document.getElementById('quarterlyToggleBtn');
            const fullscreenModal = document.getElementById('fullscreen-chart-modal');
            const fullscreenCanvas = document.getElementById('fullscreen-canvas');
            const closeFullscreenBtn = document.getElementById('close-fullscreen-btn');
            
            
            const tickerInput = document.getElementById('tickerInput');
            const getCurrentDataBtn = document.getElementById('getCurrentDataBtn');
            const companyInfoDiv = document.getElementById('companyInfo');
            const companyLogo = document.getElementById('companyLogo');
            const companyNameDisplay = document.getElementById('companyName');
            const currentStockPriceDisplay = document.getElementById('currentStockPrice');
            const earningsTabBtn = document.getElementById('earningsTabBtn');
            const cashFlowTabBtn = document.getElementById('cashFlowTabBtn');
            const earningsSection = document.getElementById('earningsSection');
            const cashFlowSection = document.getElementById('cashFlowSection');
            const currentEpsDisplay = document.getElementById('currentEps');
            const currentPeDisplay = document.getElementById('currentPe');
            const epsGrowthDisplay = document.getElementById('epsGrowth');
            const epsTtmInput = document.getElementById('epsTtmInput');
            const growthRateInput = document.getElementById('growthRateInput');
            const peMultipleInput = document.getElementById('peMultipleInput');
            const currentFcfShareDisplay = document.getElementById('currentFcfShare');
            const fcfYieldDisplay = document.getElementById('fcfYield');
            const sbcImpactDisplay = document.getElementById('sbcImpact');
            const fcfShareInput = document.getElementById('fcfShareInput');
            const fcfGrowthRateInput = document.getElementById('fcfGrowthRateInput');
            const fcfYieldInput = document.getElementById('fcfYieldInput');
            const desiredReturnInput = document.getElementById('desiredReturnInput');
            const calculatePriceBtn = document.getElementById('calculatePriceBtn');
            const saveCalculationBtn = document.getElementById('saveCalculationBtn');
            const loadCalculationsBtn = document.getElementById('loadCalculationsBtn');
            const savedCalculationsContainer = document.getElementById('savedCalculationsContainer');
            const priceChartCanvas = document.getElementById('priceChart');
            const confirmationModal = document.getElementById('confirmationModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const confirmYesBtn = document.getElementById('confirmYesBtn');
            const confirmNoBtn = document.getElementById('confirmNoBtn');
            const projectionPlaceholder = document.getElementById('projectionPlaceholder');
            const projectionOutput = document.getElementById('projectionOutput');
            const calculationResultsDiv = document.getElementById('calculationResults');

            
            const returnFromTodayDisplay = document.getElementById('returnFromTodayDisplay');
            const entryPriceDisplay = document.getElementById('entryPriceDisplay');
            const desiredReturnDisplay = document.getElementById('desiredReturnDisplay');
            const priceAfter5YearsDisplay = document.getElementById('priceAfter5YearsDisplay');

            
            const toastContainer = document.getElementById('toast-container');


            let activeFullscreenChart = null;
            let dcfProjectionChart = null;
            let currentStockPrice = 0;
            let activeTab = 'earnings';
            let currentTicker = '';
            let modalCallback = null;
            let fullInsightsData = {}; 
            let currentPeriod = 'quarterly'; // Default to quarterly
            let currentUser = null; 

            
            onAuthStateChanged(auth, (user) => { 
                currentUser = user;
                if (user) {
                    
                    console.log("User signed in:", user.email, "Email Verified:", user.emailVerified);
                    
                    if (user.emailVerified || user.providerData[0].providerId === 'google.com') {
                        showPage(mainMenu);
                    } else {
                        showPage(loginPage); // Keep them on login page if email not verified
                        showToast('Please verify your email address to continue.', true);
                    }
                } else {
                    
                    console.log("User signed out.");
                    showPage(loginPage);
                }
            });


            
            function showPage(page) {
                mainMenu.classList.add('hidden');
                loginPage.classList.add('hidden');
                registerPage.classList.add('hidden');
                appContent.classList.add('hidden');
                insightsPage.classList.add('hidden');
                page.classList.remove('hidden');
            }

            dcfCalculatorMenuBtn.addEventListener('click', () => showPage(appContent));
            insightsMenuBtn.addEventListener('click', () => showPage(insightsPage));
            logoutMenuBtn.addEventListener('click', handleLogout);
            backToMenuBtn.addEventListener('click', () => showPage(mainMenu));
            insightsBackToMenuBtn.addEventListener('click', () => showPage(mainMenu));
            showRegisterBtn.addEventListener('click', () => showPage(registerPage));
            showLoginBtn.addEventListener('click', () => showPage(loginPage));
            
            
            function createChart(canvas, title, chartData, isFullscreen = false) {
                const ctx = canvas.getContext('2d');
                
                const datasetOptions = {
                    label: title,
                    data: chartData.data,
                    backgroundColor: chartData.backgroundColor,
                    borderColor: chartData.borderColor,
                    borderWidth: chartData.type === 'bar' ? 1 : 2,
                    fill: chartData.type === 'line',
                    tension: 0.1,
                    pointBackgroundColor: chartData.borderColor,
                    pointHoverRadius: 5,
                    pointRadius: 3
                };
                
                let onClickHandler = isFullscreen ? null : () => openFullscreen(title);

                
                if (title.includes('Price')) {
                    datasetOptions.pointRadius = 0;
                }
                
                if (title === 'Projected Price Growth') {
                    datasetOptions.pointRadius = 3; 
                    onClickHandler = null; 
                }

                const chartInstance = new Chart(ctx, {
                    type: chartData.type,
                    data: {
                        labels: chartData.labels,
                        datasets: [datasetOptions]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: isFullscreen, labels: { color: '#212529' } } },
                        
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: { color: '#e9ecef' },
                                ticks: {
                                    color: '#6c757d',
                                    callback: function(value, index, values) {
                                        const chartTitlesToFormat = ['Revenue (Total)', 'Free Cash Flow', 'Net Income', 'Operating Income (EBIT)', 'Assets', 'Liabilities', 'Capital Expenditures', 'Cash', 'Goodwill', 'Property, Plant and Equipment, Net', 'Retained Earnings', 'Stockholders\' Equity', 'Operating Cash Flow', 'Current Assets', 'Current Liabilities'];
                                        if (chartTitlesToFormat.includes(title)) {
                                            if (Math.abs(value) >= 1000000000) {
                                                return '$' + (value / 1000000000).toFixed(1) + 'B';
                                            }
                                            if (Math.abs(value) >= 1000000) {
                                                return '$' + (value / 1000000).toFixed(1) + 'M';
                                            }
                                            return '$' + value.toLocaleString();
                                        }
                                        return value.toLocaleString();
                                    }
                                }
                            },
                            x: { grid: { display: false }, ticks: { color: '#6c757d' } }
                        }
                    ,
                        onClick: onClickHandler
                    }
                });
                return chartInstance;
            }

            function openFullscreen(title) {
                fullscreenModal.classList.remove('hidden');
                if (activeFullscreenChart) activeFullscreenChart.destroy();
                
                // Get the full data for the selected chart from the current period
                const fullChartData = fullInsightsData[currentPeriod][title];
                
                activeFullscreenChart = createChart(fullscreenCanvas, title, fullChartData, true);
            }

            closeFullscreenBtn.addEventListener('click', () => {
                fullscreenModal.classList.add('hidden');
                if (activeFullscreenChart) {
                    activeFullscreenChart.destroy();
                    activeFullscreenChart = null;
                }
            });

            
            function renderInsightsCharts() {
                insightsGrid.innerHTML = '';
                
                const financialData = fullInsightsData[currentPeriod] || {};

                if (Object.keys(financialData).length === 0) {
                    insightsGrid.innerHTML = `<p class="text-center text-red-500 col-span-full">No insights data found for the selected ticker.</p>`;
                    return;
                }

                // Define a more logical order for financial charts
                const chartOrder = [
                    'Revenue (Total)', 'Operating Income (EBIT)', 'Net Income', 'Earnings per Share (EPS)',
                    'Free Cash Flow', 'Operating Cash Flow', 'Capital Expenditures',
                    'Assets', 'Liabilities', 'Stockholders\' Equity', 'Shares Outstanding'
                ];

                const allCharts = { ...financialData };
                const remainingCharts = Object.keys(allCharts).filter(title => !chartOrder.includes(title));
                const finalChartOrder = [...chartOrder, ...remainingCharts];

                finalChartOrder.forEach(title => {
                    const chartData = allCharts[title];
                    if (chartData && chartData.data && chartData.data.length > 0) {
                        
                        const previewData = { ...chartData };
                        // New requirement: show last 4 years of quarterly data (16 quarters)
                        if (previewData.labels.length > 16) {
                            previewData.labels = previewData.labels.slice(-16);
                            previewData.data = previewData.data.slice(-16);
                        }

                        const chartCard = document.createElement('div');
                        chartCard.className = 'chart-card';
                        chartCard.innerHTML = `<h3>${title}</h3><div style="position: relative; height: 250px;"><canvas></canvas></div>`;
                        insightsGrid.appendChild(chartCard);
                        const canvas = chartCard.querySelector('canvas');
                        createChart(canvas, title, previewData, false);
                    }
                });
            }

            async function fetchInsightsData() {
                const ticker = insightsTickerInput.value.trim().toUpperCase();
                if (!ticker) {
                    showToast('Please enter a ticker symbol to see financial insights.', true);
                    insightsGrid.innerHTML = '<p class="text-center text-gray-500 col-span-full">Please enter a ticker symbol to see financial insights.</p>';
                    return;
                }

                setButtonState(getInsightsBtn, 'Loading...', true);
                insightsGrid.innerHTML = '<p class="text-center text-gray-500 col-span-full">Processing data...</p>';

                try {
                    // User-provided data for GOOGL
                    const rawData = [{"data":{"Assets":"475374000000","Capital Expenditures":"17197000000","Cash":"23264000000","Current Assets":"162052000000","Current Liabilities":"91654000000","Earnings per Share (EPS)":"2.81","Free Cash Flow":"53347000000","Goodwill":"32173000000","Liabilities":"130107000000","Net Income":"34540000000","Operating Cash Flow":"36150000000","Operating Income (EBIT)":"30606000000","Other Assets, Noncurrent":"12950000000","Property, Plant and Equipment, Net":"185062000000","Retained Earnings":"262628000000","Revenue (Total)":"90234000000","Shares Outstanding":"12291000000","Stockholders' Equity":"345267000000"},"filing_date":"Q1 2025","ticker":"GOOGL"},{"data":{"Assets":"502053000000","Capital Expenditures":"39643000000","Cash":"21036000000","Current Assets":"166216000000","Current Liabilities":"87310000000","Earnings per Share (EPS)":"2.31","Free Cash Flow":"103540000000","Goodwill":"32335000000","Liabilities":"139137000000","Net Income":"28196000000","Operating Cash Flow":"63897000000","Operating Income (EBIT)":"31271000000","Other Assets, Noncurrent":"14153000000","Retained Earnings":"275760000000","Revenue (Total)":"39039000000","Shares Outstanding":"12198000000","Stockholders' Equity":"362916000000"},"filing_date":"Q2 2025","ticker":"GOOGL"},{"data":{"Assets":"407350000000","Capital Expenditures":"12012000000","Cash":"24493000000","Current Assets":"165471000000","Current Liabilities":"76997000000","Earnings per Share (EPS)":"1.89","Free Cash Flow":"40860000000","Goodwill":"29183000000","Liabilities":"114506000000","Net Income":"23662000000","Operating Cash Flow":"28848000000","Operating Income (EBIT)":"25472000000","Other Assets, Noncurrent":"10065000000","Property, Plant and Equipment, Net":"143182000000","Retained Earnings":"219770000000","Revenue (Total)":"80539000000","Shares Outstanding":"12495000000","Stockholders' Equity":"292844000000"},"filing_date":"Q1 2024","ticker":"GOOGL"},{"data":{"Assets":"414770000000","Capital Expenditures":"25198000000","Cash":"27225000000","Current Assets":"161995000000","Current Liabilities":"77913000000","Earnings per Share (EPS)":"1.89","Free Cash Flow":"80686000000","Goodwill":"29185000000","Liabilities":"114017000000","Net Income":"23619000000","Operating Cash Flow":"55488000000","Operating Income (EBIT)":"27425000000","Other Assets, Noncurrent":"9699000000","Property, Plant and Equipment, Net":"151155000000","Retained Earnings":"226033000000","Revenue (Total)":"84742000000","Shares Outstanding":"12495000000","Stockholders' Equity":"300753000000"},"filing_date":"Q2 2024","ticker":"GOOGL"},{"data":{"Assets":"430266000000","Capital Expenditures":"38259000000","Cash":"19959000000","Current Assets":"157541000000","Current Liabilities":"80803000000","Earnings per Share (EPS)":"2.12","Free Cash Flow":"124445000000","Goodwill":"31935000000","Liabilities":"116147000000","Net Income":"26301000000","Operating Cash Flow":"86186000000","Operating Income (EBIT)":"28521000000","Other Assets, Noncurrent":"13867000000","Property, Plant and Equipment, Net":"161270000000","Retained Earnings":"235317000000","Revenue (Total)":"88268000000","Shares Outstanding":"12419000000","Stockholders' Equity":"314119000000"},"filing_date":"Q3 2024","ticker":"GOOGL"},{"data":{"Assets":"450256000000","Capital Expenditures":"52535000000","Cash":"23466000000","Current Assets":"163711000000","Current Liabilities":"89122000000","Earnings per Share (EPS)":"8.04","Free Cash Flow":"177834000000","Goodwill":"31885000000","Liabilities":"125172000000","Net Income":"100118000000","Operating Cash Flow":"125299000000","Operating Income (EBIT)":"112390000000","Other Assets, Noncurrent":"14874000000","Property, Plant and Equipment, Net":"171036000000","Retained Earnings":"245084000000","Revenue (Total)":"350018000000","Shares Outstanding":"12447000000","Stockholders' Equity":"325084000000"},"filing_date":"Q4 2024","ticker":"GOOGL"},{"data":{"Assets":"369491000000","Capital Expenditures":"6289000000","Cash":"25924000000","Current Assets":"161985000000","Current Liabilities":"68854000000","Earnings per Share (EPS)":"1.17","Free Cash Flow":"29798000000","Goodwill":"28994000000","Liabilities":"108597000000","Net Income":"15051000000","Operating Cash Flow":"23509000000","Operating Income (EBIT)":"17415000000","Other Assets, Noncurrent":"6439000000","Retained Earnings":"196625000000","Revenue (Total)":"69787000000","Shares Outstanding":"12617000000","Stockholders' Equity":"260894000000"},"filing_date":"Q1 2023","ticker":"GOOGL"},{"data":{"Assets":"383044000000","Capital Expenditures":"13177000000","Cash":"25929000000","Current Assets":"168788000000","Current Liabilities":"77709000000","Earnings per Share (EPS)":"1.44","Free Cash Flow":"65352000000","Goodwill":"29210000000","Liabilities":"115903000000","Net Income":"18368000000","Operating Cash Flow":"52175000000","Operating Income (EBIT)":"21838000000","Other Assets, Noncurrent":"6822000000","Retained Earnings":"200884000000","Revenue (Total)":"74604000000","Shares Outstanding":"12756000000","Stockholders' Equity":"267141000000"},"filing_date":"Q2 2023","ticker":"GOOGL"},{"data":{"Assets":"396711000000","Capital Expenditures":"21232000000","Cash":"30702000000","Current Assets":"176310000000","Current Liabilities":"86295000000","Earnings per Share (EPS)":"1.55","Free Cash Flow":"104063000000","Goodwill":"29146000000","Liabilities":"123509000000","Net Income":"19689000000","Operating Cash Flow":"82831000000","Operating Income (EBIT)":"21343000000","Other Assets, Noncurrent":"7628000000","Retained Earnings":"205647000000","Revenue (Total)":"76693000000","Shares Outstanding":"12703000000","Stockholders' Equity":"273202000000"},"filing_date":"Q3 2023","ticker":"GOOGL"},{"data":{"Assets":"402392000000","Capital Expenditures":"32251000000","Cash":"24048000000","Current Assets":"171530000000","Current Liabilities":"81814000000","Earnings per Share (EPS)":"5.80","Free Cash Flow":"133997000000","Goodwill":"29198000000","Liabilities":"119013000000","Net Income":"73795000000","Operating Cash Flow":"101746000000","Operating Income (EBIT)":"84293000000","Other Assets, Noncurrent":"10051000000","Property, Plant and Equipment, Net":"134345000000","Retained Earnings":"211247000000","Revenue (Total)":"307394000000","Shares Outstanding":"12723000000","Stockholders' Equity":"283379000000"},"filing_date":"Q4 2023","ticker":"GOOGL"},{"data":{"Assets":"357096000000","Capital Expenditures":"9786000000","Cash":"20886000000","Current Assets":"177853000000","Current Liabilities":"61948000000","Earnings per Share (EPS)":"24.62","Free Cash Flow":"34892000000","Goodwill":"23010000000","Liabilities":"103092000000","Net Income":"16436000000","Operating Cash Flow":"25106000000","Operating Income (EBIT)":"20094000000","Other Assets, Noncurrent":"5778000000","Retained Earnings":"195221000000","Revenue (Total)":"68011000000","Shares Outstanding":"667600000","Stockholders' Equity":"254004000000"},"filing_date":"Q1 2022","ticker":"GOOGL"},{"data":{"Assets":"355185000000","Capital Expenditures":"16614000000","Cash":"17936000000","Current Assets":"172371000000","Current Liabilities":"61354000000","Earnings per Share (EPS)":"1.21","Free Cash Flow":"61142000000","Goodwill":"23949000000","Liabilities":"99766000000","Net Income":"16002000000","Operating Cash Flow":"44528000000","Operating Income (EBIT)":"19453000000","Other Assets, Noncurrent":"5712000000","Retained Earnings":"196845000000","Revenue (Total)":"69685000000","Shares Outstanding":"13225000000","Stockholders' Equity":"255419000000"},"filing_date":"Q2 2022","ticker":"GOOGL"},{"data":{"Assets":"358255000000","Capital Expenditures":"23890000000","Cash":"21984000000","Current Assets":"166109000000","Current Liabilities":"65979000000","Earnings per Share (EPS)":"1.06","Free Cash Flow":"91771000000","Goodwill":"28834000000","Liabilities":"104629000000","Net Income":"13910000000","Operating Cash Flow":"67881000000","Operating Income (EBIT)":"17135000000","Other Assets, Noncurrent":"5670000000","Retained Earnings":"196220000000","Revenue (Total)":"69092000000","Shares Outstanding":"13123000000","Stockholders' Equity":"253626000000"},"filing_date":"Q3 2022","ticker":"GOOGL"},{"data":{"Assets":"365264000000","Capital Expenditures":"31485000000","Cash":"21879000000","Current Assets":"164795000000","Current Liabilities":"69300000000","Earnings per Share (EPS)":"4.56","Free Cash Flow":"122980000000","Goodwill":"28960000000","Liabilities":"109120000000","Net Income":"59972000000","Operating Cash Flow":"91495000000","Operating Income (EBIT)":"74842000000","Other Assets, Noncurrent":"6623000000","Property, Plant and Equipment, Net":"112668000000","Retained Earnings":"195563000000","Revenue (Total)":"282836000000","Shares Outstanding":"13152000000","Stockholders' Equity":"256144000000"},"filing_date":"Q4 2022","ticker":"GOOGL"},{"data":{"Assets":"327095000000","Capital Expenditures":"5942000000","Cash":"26622000000","Current Assets":"172137000000","Current Liabilities":"55453000000","Earnings per Share (EPS)":"26.29","Free Cash Flow":"25231000000","Goodwill":"22341000000","Liabilities":"97082000000","Net Income":"17930000000","Operating Cash Flow":"19289000000","Operating Income (EBIT)":"16437000000","Other Assets, Noncurrent":"4167000000","Retained Earnings":"170580000000","Revenue (Total)":"55314000000","Shares Outstanding":"681000000","Stockholders' Equity":"230013000000"},"filing_date":"Q1 2021","ticker":"GOOGL"},{"data":{"Assets":"335387000000","Capital Expenditures":"11438000000","Cash":"23630000000","Current Assets":"175697000000","Current Liabilities":"55741000000","Earnings per Share (EPS)":"27.26","Free Cash Flow":"52617000000","Goodwill":"22406000000","Liabilities":"97822000000","Net Income":"18525000000","Operating Cash Flow":"41179000000","Operating Income (EBIT)":"19361000000","Other Assets, Noncurrent":"4298000000","Retained Earnings":"176939000000","Revenue (Total)":"61880000000","Shares Outstanding":"680000000","Stockholders' Equity":"237565000000"},"filing_date":"Q2 2021","ticker":"GOOGL"},{"data":{"Assets":"347403000000","Capital Expenditures":"18257000000","Cash":"23719000000","Current Assets":"184110000000","Current Liabilities":"61782000000","Earnings per Share (EPS)":"27.99","Free Cash Flow":"84975000000","Goodwill":"22623000000","Liabilities":"102836000000","Net Income":"18936000000","Operating Cash Flow":"66718000000","Operating Income (EBIT)":"21031000000","Other Assets, Noncurrent":"4276000000","Retained Earnings":"183782000000","Revenue (Total)":"65118000000","Shares Outstanding":"676500000","Stockholders' Equity":"244567000000"},"filing_date":"Q3 2021","ticker":"GOOGL"},{"data":{"Assets":"359268000000","Capital Expenditures":"24640000000","Cash":"20945000000","Current Assets":"188143000000","Current Liabilities":"64254000000","Earnings per Share (EPS)":"112.20","Free Cash Flow":"116292000000","Goodwill":"22956000000","Liabilities":"107633000000","Net Income":"76033000000","Operating Cash Flow":"91652000000","Operating Income (EBIT)":"78714000000","Other Assets, Noncurrent":"5361000000","Property, Plant and Equipment, Net":"97599000000","Retained Earnings":"191484000000","Revenue (Total)":"110939000000","Shares Outstanding":"677700000","Stockholders' Equity":"251635000000"},"filing_date":"Q4 2021","ticker":"GOOGL"},{"data":{"Assets":"273403000000","Capital Expenditures":"6005000000","Cash":"19644000000","Current Assets":"147018000000","Current Liabilities":"40189000000","Earnings per Share (EPS)":"9.87","Free Cash Flow":"17456000000","Goodwill":"20734000000","Liabilities":"69744000000","Net Income":"6836000000","Operating Cash Flow":"11451000000","Operating Income (EBIT)":"7977000000","Other Assets, Noncurrent":"2748000000","Retained Earnings":"151068000000","Revenue (Total)":"41159000000","Shares Outstanding":"692600000","Stockholders' Equity":"203659000000"},"filing_date":"Q1 2020","ticker":"GOOGL"},{"data":{"Assets":"278492000000","Capital Expenditures":"5391000000","Cash":"17742000000","Current Assets":"149069000000","Current Liabilities":"43658000000","Earnings per Share (EPS)":"10.13","Free Cash Flow":"30835000000","Goodwill":"20824000000","Liabilities":"71170000000","Net Income":"6959000000","Operating Cash Flow":"25444000000","Operating Income (EBIT)":"6383000000","Other Assets, Noncurrent":"2731000000","Retained Earnings":"151681000000","Revenue (Total)":"38297000000","Shares Outstanding":"687000000","Stockholders' Equity":"207322000000"},"filing_date":"Q2 2020","ticker":"GOOGL"},{"data":{"Assets":"299243000000","Capital Expenditures":"5406000000","Cash":"20129000000","Current Assets":"164369000000","Current Liabilities":"48200000000","Earnings per Share (EPS)":"16.40","Free Cash Flow":"47853000000","Goodwill":"20870000000","Liabilities":"86323000000","Net Income":"11247000000","Operating Cash Flow":"42447000000","Operating Income (EBIT)":"11213000000","Other Assets, Noncurrent":"3274000000","Retained Earnings":"155567000000","Revenue (Total)":"46173000000","Shares Outstanding":"685800000","Stockholders' Equity":"212920000000"},"filing_date":"Q3 2020","ticker":"GOOGL"},{"data":{"Assets":"319616000000","Capital Expenditures":"22281000000","Cash":"26465000000","Current Assets":"174296000000","Current Liabilities":"56834000000","Earnings per Share (EPS)":"58.61","Free Cash Flow":"87405000000","Goodwill":"21175000000","Liabilities":"97072000000","Net Income":"40269000000","Operating Cash Flow":"65124000000","Operating Income (EBIT)":"41224000000","Other Assets, Noncurrent":"3953000000","Property, Plant and Equipment, Net":"84749000000","Retained Earnings":"163401000000","Revenue (Total)":"84732000000","Shares Outstanding":"687000000","Stockholders' Equity":"222544000000"},"filing_date":"Q4 2020","ticker":"GOOGL"},{"data":{"Assets":"245349000000","Capital Expenditures":"4638000000","Cash":"19148000000","Current Assets":"138207000000","Current Liabilities":"34910000000","Earnings per Share (EPS)":"9.50","Free Cash Flow":"16638000000","Goodwill":"17943000000","Liabilities":"61877000000","Net Income":"6657000000","Operating Cash Flow":"12000000000","Operating Income (EBIT)":"6608000000","Other Assets, Noncurrent":"2547000000","Property, Plant and Equipment, Net":"60528000000","Retained Earnings":"138720000000","Revenue (Total)":"36339000000","Shares Outstanding":"700700000","Stockholders' Equity":"183472000000"},"filing_date":"Q1 2019","ticker":"GOOGL"},{"data":{"Assets":"257101000000","Capital Expenditures":"6126000000","Cash":"16587000000","Current Assets":"147437000000","Current Liabilities":"37000000000","Earnings per Share (EPS)":"14.21","Free Cash Flow":"30753000000","Goodwill":"18000000000","Liabilities":"64909000000","Net Income":"9947000000","Operating Cash Flow":"24627000000","Operating Income (EBIT)":"9180000000","Other Assets, Noncurrent":"2461000000","Property, Plant and Equipment, Net":"64891000000","Retained Earnings":"145346000000","Revenue (Total)":"38944000000","Shares Outstanding":"700000000","Stockholders' Equity":"192192000000"},"filing_date":"Q2 2019","ticker":"GOOGL"},{"data":{"Assets":"263044000000","Capital Expenditures":"6732000000","Cash":"16032000000","Current Assets":"148358000000","Current Liabilities":"39224000000","Earnings per Share (EPS)":"10.12","Free Cash Flow":"46825000000","Goodwill":"18069000000","Liabilities":"68075000000","Net Income":"7068000000","Operating Cash Flow":"40093000000","Operating Income (EBIT)":"9177000000","Other Assets, Noncurrent":"2225000000","Property, Plant and Equipment, Net":"69252000000","Retained Earnings":"147125000000","Revenue (Total)":"40499000000","Shares Outstanding":"698400000","Stockholders' Equity":"194969000000"},"filing_date":"Q3 2019","ticker":"GOOGL"},{"data":{"Assets":"275909000000","Capital Expenditures":"23548000000","Cash":"18498000000","Current Assets":"152578000000","Current Liabilities":"45221000000","Earnings per Share (EPS)":"49.16","Free Cash Flow":"78068000000","Goodwill":"20624000000","Liabilities":"74467000000","Net Income":"34343000000","Operating Cash Flow":"54520000000","Operating Income (EBIT)":"34231000000","Other Assets, Noncurrent":"2342000000","Property, Plant and Equipment, Net":"59719000000","Retained Earnings":"152122000000","Revenue (Total)":"161857000000","Shares Outstanding":"698400000","Stockholders' Equity":"201442000000"},"filing_date":"Q4 2019","ticker":"GOOGL"},{"data":{"Assets":"206935000000","Capital Expenditures":"7299000000","Cash":"12658000000","Current Assets":"123761000000","Current Liabilities":"25394000000","Earnings per Share (EPS)":"13.33","Free Cash Flow":"18941000000","Goodwill":"17862000000","Liabilities":"46110000000","Net Income":"9401000000","Operating Cash Flow":"11642000000","Operating Income (EBIT)":"7001000000","Other Assets, Noncurrent":"2004000000","Property, Plant and Equipment, Net":"48845000000","Retained Earnings":"120008000000","Revenue (Total)":"31146000000","Shares Outstanding":"705200000","Stockholders' Equity":"160825000000"},"filing_date":"Q1 2018","ticker":"GOOGL"},{"data":{"Assets":"211610000000","Capital Expenditures":"5477000000","Cash":"14148000000","Current Assets":"124157000000","Current Liabilities":"29903000000","Earnings per Share (EPS)":"4.54","Free Cash Flow":"27251000000","Goodwill":"17895000000","Liabilities":"49610000000","Net Income":"3195000000","Operating Cash Flow":"21774000000","Operating Income (EBIT)":"2807000000","Other Assets, Noncurrent":"3052000000","Property, Plant and Equipment, Net":"51672000000","Retained Earnings":"121282000000","Revenue (Total)":"32657000000","Shares Outstanding":"703700000","Stockholders' Equity":"162000000000"},"filing_date":"Q2 2018","ticker":"GOOGL"},{"data":{"Assets":"221538000000","Capital Expenditures":"5282000000","Cash":"13443000000","Current Assets":"129702000000","Current Liabilities":"31301000000","Earnings per Share (EPS)":"13.06","Free Cash Flow":"40266000000","Goodwill":"17895000000","Liabilities":"51698000000","Net Income":"9192000000","Operating Cash Flow":"34984000000","Operating Income (EBIT)":"8310000000","Other Assets, Noncurrent":"2838000000","Property, Plant and Equipment, Net":"55300000000","Retained Earnings":"128405000000","Revenue (Total)":"33740000000","Shares Outstanding":"703800000","Stockholders' Equity":"169840000000"},"filing_date":"Q3 2018","ticker":"GOOGL"},{"data":{"Assets":"232792000000","Capital Expenditures":"25139000000","Cash":"16701000000","Current Assets":"135676000000","Current Liabilities":"34620000000","Earnings per Share (EPS)":"43.70","Free Cash Flow":"73110000000","Goodwill":"17888000000","Liabilities":"55164000000","Net Income":"30736000000","Operating Cash Flow":"47971000000","Operating Income (EBIT)":"26321000000","Other Assets, Noncurrent":"2693000000","Property, Plant and Equipment, Net":"59719000000","Retained Earnings":"134885000000","Revenue (Total)":"136819000000","Shares Outstanding":"703300000","Stockholders' Equity":"177628000000"},"filing_date":"Q4 2018","ticker":"GOOGL"},{"data":{"Assets":"172756000000","Capital Expenditures":"2508000000","Cash":"18132000000","Current Assets":"108794000000","Current Liabilities":"15256000000","Earnings per Share (EPS)":"7.73","Free Cash Flow":"12056000000","Goodwill":"16547000000","Liabilities":"27807000000","Net Income":"5426000000","Operating Cash Flow":"9548000000","Operating Income (EBIT)":"6568000000","Property, Plant and Equipment, Net":"35936000000","Retained Earnings":"109420000000","Revenue (Total)":"9795000000","Shares Outstanding":"701900000","Stockholders' Equity":"144949000000"},"filing_date":"Q1 2017","ticker":"GOOGL"},{"data":{"Assets":"178621000000","Capital Expenditures":"2831000000","Cash":"15711000000","Current Assets":"112386000000","Current Liabilities":"18685000000","Earnings per Share (EPS)":"5.01","Free Cash Flow":"19782000000","Goodwill":"16604000000","Liabilities":"30335000000","Net Income":"3524000000","Operating Cash Flow":"16951000000","Operating Income (EBIT)":"4132000000","Property, Plant and Equipment, Net":"37676000000","Retained Earnings":"111505000000","Revenue (Total)":"10373000000","Shares Outstanding":"703400000","Stockholders' Equity":"148286000000"},"filing_date":"Q2 2017","ticker":"GOOGL"},{"data":{"Assets":"189536000000","Capital Expenditures":"3538000000","Cash":"10581000000","Current Assets":"119345000000","Current Liabilities":"20693000000","Earnings per Share (EPS)":"9.57","Free Cash Flow":"30361000000","Goodwill":"16731000000","Liabilities":"32436000000","Net Income":"6732000000","Operating Cash Flow":"26823000000","Operating Income (EBIT)":"7782000000","Other Assets, Noncurrent":"2683000000","Property, Plant and Equipment, Net":"40120000000","Retained Earnings":"118237000000","Revenue (Total)":"11148000000","Shares Outstanding":"703400000","Stockholders' Equity":"157100000000"},"filing_date":"Q3 2017","ticker":"GOOGL"},{"data":{"Assets":"197295000000","Capital Expenditures":"13184000000","Cash":"10715000000","Current Assets":"124308000000","Current Liabilities":"24183000000","Free Cash Flow":"50275000000","Goodwill":"16747000000","Liabilities":"44793000000","Net Income":"12662000000","Operating Cash Flow":"37091000000","Operating Income (EBIT)":"26146000000","Other Assets, Noncurrent":"2672000000","Property, Plant and Equipment, Net":"42383000000","Retained Earnings":"113247000000","Revenue (Total)":"45583000000","Shares Outstanding":"703400000","Stockholders' Equity":"152502000000"},"filing_date":"Q4 2017","ticker":"GOOGL"},{"data":{"Assets":"149747000000","Capital Expenditures":"2428000000","Cash":"15111000000","Current Assets":"90955000000","Current Liabilities":"17684000000","Free Cash Flow":"10086000000","Goodwill":"15866000000","Liabilities":"26178000000","Net Income":"4207000000","Operating Cash Flow":"7658000000","Operating Income (EBIT)":"5342000000","Property, Plant and Equipment, Net":"30162000000","Retained Earnings":"91168000000","Revenue (Total)":"7648000000","Shares Outstanding":"698400000","Stockholders' Equity":"123569000000"},"filing_date":"Q1 2016","ticker":"GOOGL"},{"data":{"Assets":"154292000000","Capital Expenditures":"2123000000","Cash":"13627000000","Current Assets":"94238000000","Current Liabilities":"17341000000","Free Cash Flow":"18901000000","Goodwill":"15841000000","Liabilities":"26413000000","Net Income":"4877000000","Operating Cash Flow":"16778000000","Operating Income (EBIT)":"5968000000","Property, Plant and Equipment, Net":"31413000000","Retained Earnings":"94737000000","Revenue (Total)":"8130000000","Shares Outstanding":"698400000","Stockholders' Equity":"127879000000"},"filing_date":"Q2 2016","ticker":"GOOGL"},{"data":{"Assets":"159948000000","Capital Expenditures":"2554000000","Cash":"9406000000","Current Assets":"98546000000","Current Liabilities":"14323000000","Free Cash Flow":"29177000000","Goodwill":"16028000000","Liabilities":"25845000000","Net Income":"5061000000","Operating Cash Flow":"26623000000","Operating Income (EBIT)":"5767000000","Property, Plant and Equipment, Net":"32753000000","Retained Earnings":"99798000000","Revenue (Total)":"8699000000","Shares Outstanding":"698400000","Stockholders' Equity":"134103000000"},"filing_date":"Q3 2016","ticker":"GOOGL"},{"data":{"Assets":"167497000000","Capital Expenditures":"10212000000","Cash":"12918000000","Current Assets":"105408000000","Current Liabilities":"16756000000","Free Cash Flow":"46248000000","Goodwill":"16468000000","Liabilities":"28461000000","Net Income":"19478000000","Operating Cash Flow":"36036000000","Operating Income (EBIT)":"23716000000","Property, Plant and Equipment, Net":"34234000000","Retained Earnings":"105131000000","Revenue (Total)":"35138000000","Shares Outstanding":"698400000","Stockholders' Equity":"139036000000"},"filing_date":"Q4 2016","ticker":"GOOGL"},{"data":{"Assets":"147461000000","Capital Expenditures":"9915000000","Cash":"16549000000","Current Assets":"90114000000","Current Liabilities":"19310000000","Earnings per Share (EPS)":"20.57","Free Cash Flow":"36487000000","Goodwill":"15869000000","Net Income":"16348000000","Operating Cash Flow":"26572000000","Operating Income (EBIT)":"19360000000","Property, Plant and Equipment, Net":"29016000000","Retained Earnings":"89223000000","Revenue (Total)":"28164000000","Shares Outstanding":"794700000","Stockholders' Equity":"120331000000"},"filing_date":"Q4 2015","ticker":"GOOGL"},{"data":{"Assets":"144281000000","Capital Expenditures":"7815000000","Cash":"18068000000","Current Assets":"88103000000","Current Liabilities":"18457000000","Earnings per Share (EPS)":"5.10","Free Cash Flow":"27424000000","Goodwill":"15675000000","Net Income":"3979000000","Operating Cash Flow":"19609000000","Operating Income (EBIT)":"4708000000","Property, Plant and Equipment, Net":"28338000000","Retained Earnings":"85969000000","Revenue (Total)":"7037000000","Shares Outstanding":"780200000","Stockholders' Equity":"116241000000"},"filing_date":"Q3 2015","ticker":"GOOGL"}];

                    // Helper to sort data by filing date
                    const sortFinancialData = (data) => {
                        return data.sort((a, b) => {
                            const [aQ, aY] = a.filing_date.split(' ');
                            const [bQ, bY] = b.filing_date.split(' ');
                            if (aY !== bY) return parseInt(aY) - parseInt(bY);
                            return parseInt(aQ.substring(1)) - parseInt(bQ.substring(1));
                        });
                    };

                    const sortedData = sortFinancialData(rawData);
                    const quarterlyData = {};
                    if (sortedData.length === 0) {
                        throw new Error("No data available to process.");
                    }
                    const metrics = Object.keys(sortedData[0].data);

                    const lineChartMetrics = ['Earnings per Share (EPS)', 'Shares Outstanding'];
                    const colors = [
                        'rgba(54, 162, 235, 0.6)', 'rgba(255, 99, 132, 0.6)', 'rgba(75, 192, 192, 0.6)',
                        'rgba(255, 206, 86, 0.6)', 'rgba(153, 102, 255, 0.6)', 'rgba(255, 159, 64, 0.6)'
                    ];
                    const borderColors = [
                        'rgba(54, 162, 235, 1)', 'rgba(255, 99, 132, 1)', 'rgba(75, 192, 192, 1)',
                        'rgba(255, 206, 86, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)'
                    ];


                    metrics.forEach((metric, index) => {
                        quarterlyData[metric] = {
                            labels: sortedData.map(item => item.filing_date),
                            data: sortedData.map(item => parseFloat(item.data[metric])),
                            type: lineChartMetrics.includes(metric) ? 'line' : 'bar',
                            backgroundColor: colors[index % colors.length],
                            borderColor: borderColors[index % borderColors.length]
                        };
                    });

                    fullInsightsData = { quarterly: quarterlyData, annual: {}, price: {} }; // Set the processed data
                    currentPeriod = 'quarterly'; // Default to quarterly
                    annualToggleBtn.classList.remove('active');
                    quarterlyToggleBtn.classList.add('active');
                    annualToggleBtn.disabled = true; // Disable annual as we don't have data

                    renderInsightsCharts();
                    showToast('Insights data processed successfully!', false);

                } catch (error) {
                    insightsGrid.innerHTML = `<p class="text-center text-red-500 col-span-full">Error: ${error.message}</p>`;
                    showToast(`Failed to process insights: ${error.message}`, true);
                } finally {
                    setButtonState(getInsightsBtn, 'Get Insights', false);
                }
            }
            
            getInsightsBtn.addEventListener('click', fetchInsightsData);
            
            annualToggleBtn.addEventListener('click', () => {
                // This button is disabled, but we keep the logic just in case
                currentPeriod = 'annual';
                annualToggleBtn.classList.add('active');
                quarterlyToggleBtn.classList.remove('active');
                if (fullInsightsData.annual) renderInsightsCharts();
            });

            quarterlyToggleBtn.addEventListener('click', () => {
                currentPeriod = 'quarterly';
                quarterlyToggleBtn.classList.add('active');
                annualToggleBtn.classList.remove('active');
                if (fullInsightsData.quarterly) renderInsightsCharts();
            });

            insightsGrid.innerHTML = '<p class="text-center text-gray-500 col-span-full">Enter a ticker to begin.</p>';

            
            function setButtonState(button, text, disabled) {
                button.innerHTML = text;
                button.disabled = disabled;
            }
            async function apiCall(endpoint, options = {}) {
                const user = auth.currentUser; 
                let idToken = null;
                if (user) {
                    try {
                        idToken = await user.getIdToken();
                    } catch (error) {
                        console.error("Error getting Firebase ID token:", error);
                        handleLogout(); 
                        throw new Error('Authentication token expired or invalid. Please log in again.');
                    }
                }

                if (idToken) {
                    options.headers = { ...options.headers, 'Authorization': `Bearer ${idToken}` };
                } else {
                    console.warn(`Attempted API call to ${endpoint} without a Firebase ID token.`);
                }

                try {
                    const response = await fetch(`${backendBaseUrl}${endpoint}`, options);
                    if (response.status === 401) {
                        handleLogout(); // Force logout if 401
                        throw new Error('Session expired. Please log in again.');
                    }
                    return response;
                } catch (error) {
                    console.error(`API call to ${endpoint} failed:`, error);
                    throw error;
                }
            }
            
            async function handleLogin() {
                setButtonState(loginBtn, 'Logging in...', true);
                const email = loginEmailInput.value;
                const password = loginPasswordInput.value;

                try {
                    const userCredential = await signInWithEmailAndPassword(auth, email, password); 
                    const user = userCredential.user;
                    if (!user.emailVerified) { 
                        await signOut(auth); 
                        showToast('Please verify your email address before logging in.', true);
                        return;
                    }
                    showToast('Login successful!', false);
                } catch (error) {
                    let errorMessage = 'Login failed.';
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        errorMessage = 'Invalid email or password.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Invalid email format.';
                    } else {
                        errorMessage = error.message;
                    }
                    showToast(`Login failed: ${errorMessage}`, true);
                } finally {
                    setButtonState(loginBtn, 'Login', false);
                }
            }

            async function handleGoogleLogin() {
                setButtonState(googleLoginBtn, 'Signing in with Google...', true);
                const provider = new GoogleAuthProvider(); 
                try {
                    const result = await signInWithPopup(auth, provider); 
                    const user = result.user;
                    console.log("Google user signed in:", user.email);
                    showToast('Signed in with Google successfully!', false);
                } catch (error) {
                    let errorMessage = 'Google Sign-In failed.';
                    if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = 'Sign-in window closed.';
                    } else if (error.code === 'auth/cancelled-popup-request') {
                        errorMessage = 'Sign-in cancelled.';
                    } else {
                        errorMessage = error.message;
                    }
                    showToast(`Google Sign-In failed: ${errorMessage}`, true);
                } finally {
                    setButtonState(googleLoginBtn, 'Sign in with Google', false);
                }
            }


            async function handleRegister() {
                setButtonState(registerBtn, 'Registering...', true);
                const email = registerEmailInput.value;
                const password = registerPasswordInput.value;

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password); 
                    const user = userCredential.user;
                    await sendEmailVerification(user); 
                    showToast('Registration successful! Please check your email to verify your account.', false);
                    setTimeout(() => showPage(loginPage), 2000);
                } catch (error) {
                    let errorMessage = 'Registration failed.';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'This email is already in use.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Invalid email format.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password is too weak (min 6 characters).';
                    } else {
                        errorMessage = error.message;
                    }
                    showToast(`Registration failed: ${errorMessage}`, true);
                } finally {
                    setButtonState(registerBtn, 'Register', false);
                }
            }
            
            function handleLogout() {
                signOut(auth).then(() => { 
                    showToast('You have been successfully logged out.', false);
                }).catch((error) => {
                    showToast(`Logout failed: ${error.message}`, true);
                });
            }

            
            function clearAllFields() {
                companyInfoDiv.classList.add('hidden-state');
                if (companyLogo) companyLogo.textContent = '';
                if (companyNameDisplay) companyNameDisplay.textContent = '';
                if (currentStockPriceDisplay) currentStockPriceDisplay.textContent = '$0.00';

                if (currentEpsDisplay) currentEpsDisplay.textContent = '$0.00';
                if (currentPeDisplay) currentPeDisplay.textContent = '0.00';
                if (epsGrowthDisplay) epsGrowthDisplay.textContent = '0.0%';
                if (epsTtmInput) epsTtmInput.value = '0.00';
                if (growthRateInput) growthRateInput.value = '';
                if (peMultipleInput) peMultipleInput.value = '';

                if (currentFcfShareDisplay) currentFcfShareDisplay.textContent = '$0.00';
                if (fcfYieldDisplay) fcfYieldDisplay.textContent = '0.0%';
                if (sbcImpactDisplay) sbcImpactDisplay.textContent = '0.0%';
                if (fcfShareInput) fcfShareInput.value = '0.00';
                if (fcfGrowthRateInput) fcfGrowthRateInput.value = '';
                if (fcfYieldInput) fcfYieldInput.value = '';

                if (desiredReturnInput) desiredReturnInput.value = '';
                
                if (returnFromTodayDisplay) returnFromTodayDisplay.textContent = 'N/A';
                if (entryPriceDisplay) entryPriceDisplay.textContent = 'N/A';
                if (desiredReturnDisplay) desiredReturnDisplay.textContent = 'N/A';
                if (priceAfter5YearsDisplay) priceAfter5YearsDisplay.textContent = 'N/A';
                
                if (priceChartCanvas) {
                    if (dcfProjectionChart) {
                        dcfProjectionChart.destroy();
                        dcfProjectionChart = null; 
                    }
                }
                currentTicker = '';
            }

            async function fetchAndPopulateMetrics() {
                const ticker = tickerInput.value.trim().toUpperCase();
                if (!ticker) {
                    showToast('Please enter a ticker symbol.', true);
                    return;
                }
                setButtonState(getCurrentDataBtn, 'Fetching...', true);

                projectionPlaceholder.classList.remove('hidden');
                projectionOutput.classList.add('hidden');
                if (dcfProjectionChart) dcfProjectionChart.destroy();

                try {
                    const response = await apiCall(`/get_trailing_metrics?ticker=${ticker}`);
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Failed to fetch data');

                    companyInfoDiv.classList.remove('hidden-state');
                    companyLogo.textContent = ticker.charAt(0);
                    companyNameDisplay.textContent = data.longName || ticker;
                    currentStockPrice = data.regularMarketPrice || 0;
                    currentStockPriceDisplay.textContent = `$${currentStockPrice.toFixed(2)}`;
                    
                    const formatNum = (num, prefix = '', suffix = '') => (typeof num === 'number' && !isNaN(num)) ? `${prefix}${(num).toFixed(2)}${suffix}` : 'N/A';
                    const formatPercent = (num) => (typeof num === 'number' && !isNaN(num)) ? `${(num * 100).toFixed(2)}%` : 'N/A';

                    currentEpsDisplay.textContent = formatNum(data.trailing_eps, '$');
                    currentPeDisplay.textContent = formatNum(data.trailing_pe);
                    epsGrowthDisplay.textContent = formatPercent(data.trailing_eps_growth);
                    epsTtmInput.value = (data.trailing_eps || 0).toFixed(2);
                    
                    currentFcfShareDisplay.textContent = formatNum(data.fcfShare, '$');
                    fcfYieldDisplay.textContent = formatPercent(data.fcfYield);
                    sbcImpactDisplay.textContent = formatPercent(data.sbcImpact);
                    fcfShareInput.value = (data.fcfShare || 0).toFixed(2);

                    currentTicker = ticker;
                    showToast('Current data loaded successfully!', false);

                } catch (error) {
                    showToast(`Data fetch error: ${error.message}`, true);
                } finally {
                    setButtonState(getCurrentDataBtn, 'Search', false);
                }
            }
            
            async function saveCalculation() {
                if (!currentUser) {
                    showToast('You must be logged in to save calculations.', true);
                    showPage(loginPage);
                    return;
                }

                if (!currentUser.emailVerified && currentUser.providerData[0].providerId === 'password') {
                    showToast('Please verify your email address to save calculations.', true);
                    return;
                }

                if (!currentTicker) {
                    showToast('Please search for a ticker and calculate a price before saving.', true);
                    return;
                }

                const calculationName = prompt('Enter a name for this calculation:');
                if (!calculationName || calculationName.trim() === '') {
                    showToast('Calculation name cannot be empty.', true);
                    return;
                }

                const calculationData = captureCalculationData();
                
                try {
                    const response = await apiCall(`/save_calculation`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            ticker: currentTicker,
                            name: calculationName.trim(),
                            data: calculationData
                        })
                    });

                    const result = await response.json();
                    if (response.ok) {
                        showToast(result.message, false);
                        loadSavedCalculations();
                    } else {
                        showToast(`Error saving calculation: ${result.message}`, true);
                    }
                } catch (error) {
                    console.error('Save calculation error:', error);
                    showToast('An error occurred while saving the calculation.', true);
                }
            }
            
            async function loadSavedCalculations() {
                if (!currentUser) {
                    savedCalculationsContainer.innerHTML = '<p class="text-gray-400">Please log in to see your saved calculations.</p>';
                    return;
                }

                if (!currentUser.emailVerified && currentUser.providerData[0].providerId === 'password') {
                    savedCalculationsContainer.innerHTML = '<p class="text-gray-400">Please verify your email to load calculations.</p>';
                    showToast('Please verify your email address to load calculations.', true);
                    return;
                }

                try {
                    const response = await apiCall(`/load_calculations`);

                    const data = await response.json();

                    if (response.ok) {
                        renderSavedCalculations(data);
                        showToast('Saved calculations loaded.', false);
                    } else {
                        showToast(`Error loading calculations: ${data.message}`, true);
                        savedCalculationsContainer.innerHTML = '<p class="text-gray-400">Error loading saved calculations.</p>';
                    }
                } catch (error) {
                    console.error('Load calculations error:', error);
                    showToast('An error occurred while loading saved calculations.', true);
                    savedCalculationsContainer.innerHTML = '<p class="text-gray-400">An error occurred while loading saved calculations.</p>';
                }
            }
            
            function renderSavedCalculations(calculations) {
                savedCalculationsContainer.innerHTML = '';
                if (calculations.length === 0) {
                    savedCalculationsContainer.innerHTML = '<p class="text-gray-400">No saved calculations yet.</p>';
                    return;
                }

                calculations.forEach(calc => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'saved-calculation-item';
                    itemDiv.innerHTML = `
                        <span>${calc.name} (${calc.ticker})</span>
                        <div>
                            <button data-id="${calc.id}" class="load-btn primary-button bg-orange-500 hover:bg-orange-600">Load</button>
                            <button data-id="${calc.id}" class="delete-btn primary-button bg-red-500 hover:bg-red-600">Delete</button>
                        </div>
                    `;
                    savedCalculationsContainer.appendChild(itemDiv);
                });

                savedCalculationsContainer.querySelectorAll('.load-btn').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const calcId = event.target.dataset.id;
                        const selectedCalc = calculations.find(c => c.id === calcId);
                        if (selectedCalc) {
                            await populateFormWithCalculationData(selectedCalc.data);
                        }
                    });
                });

                savedCalculationsContainer.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const calcId = event.target.dataset.id;
                        showConfirmationModal(`Are you sure you want to delete "${calcId}"?`, async () => {
                            await deleteCalculation(calcId);
                        });
                    });
                });
            }
            function calculatePrice() {
                let currentMetric, growthRate, targetMultiple, calculationType, impliedCurrentMultiple;
                
                if (activeTab === 'earnings') {
                    currentMetric = parseFloat(epsTtmInput.value);
                    growthRate = parseFloat(growthRateInput.value) / 100;
                    targetMultiple = parseFloat(peMultipleInput.value); // This is PE
                    calculationType = 'EPS';
                    impliedCurrentMultiple = currentMetric > 0 ? currentStockPrice / currentMetric : targetMultiple;
                } else {
                    currentMetric = parseFloat(fcfShareInput.value);
                    growthRate = parseFloat(fcfGrowthRateInput.value) / 100;
                    targetMultiple = parseFloat(fcfYieldInput.value) / 100; // This is Yield
                    calculationType = 'FCF';
                    impliedCurrentMultiple = currentStockPrice > 0 ? currentMetric / currentStockPrice : targetMultiple;
                }
                const desiredReturn = parseFloat(desiredReturnInput.value) / 100;

                if (isNaN(currentMetric) || isNaN(growthRate) || isNaN(targetMultiple) || isNaN(desiredReturn)) {
                    showToast('Please fill all input fields with valid numbers.', true);
                    projectionOutput.classList.add('hidden');
                    projectionPlaceholder.classList.remove('hidden');
                    return;
                }

                projectionPlaceholder.classList.add('hidden');
                projectionOutput.classList.remove('hidden');

                const estimatedMetric5Yr = currentMetric * Math.pow(1 + growthRate, 5);
                const estimatedPrice5Yr = calculationType === 'EPS' ? estimatedMetric5Yr * targetMultiple : estimatedMetric5Yr / targetMultiple;
                const returnFromToday = currentStockPrice > 0 ? (Math.pow(estimatedPrice5Yr / currentStockPrice, 1/5) - 1) * 100 : 0;
                const entryPriceForDesiredReturn = estimatedPrice5Yr / Math.pow(1 + desiredReturn, 5);

                if (returnFromTodayDisplay) returnFromTodayDisplay.textContent = `${returnFromToday.toFixed(2)}%`;
                if (entryPriceDisplay) entryPriceDisplay.textContent = `$${entryPriceForDesiredReturn.toFixed(2)}`;
                if (desiredReturnDisplay) desiredReturnDisplay.textContent = `${(desiredReturn * 100).toFixed(2)}%`;
                if (priceAfter5YearsDisplay) priceAfter5YearsDisplay.textContent = `$${estimatedPrice5Yr.toFixed(2)}`;

                const projectedPrices = [];
                const numYears = 5;
                for (let i = 1; i <= numYears; i++) {
                    const futureMetric = currentMetric * Math.pow(1 + growthRate, i);
                    const interpolatedMultiple = impliedCurrentMultiple + (targetMultiple - impliedCurrentMultiple) * (i / numYears);
                    const futurePrice = calculationType === 'EPS' 
                        ? futureMetric * interpolatedMultiple
                        : (interpolatedMultiple > 0 ? futureMetric / interpolatedMultiple : 0);
                    projectedPrices.push(futurePrice);
                }
                
                if (dcfProjectionChart) dcfProjectionChart.destroy();
                const chartData = {
                    labels: ['Today', 'Year 1', 'Year 2', 'Year 3', 'Year 4', 'Year 5'],
                    data: [currentStockPrice, ...projectedPrices],
                    type: 'line',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    borderColor: 'rgba(40, 167, 69, 1)'
                };
                dcfProjectionChart = createChart(priceChartCanvas, 'Projected Price Growth', chartData);
            }
            
            function captureCalculationData() {
                return {
                    ticker: tickerInput.value.trim().toUpperCase(),
                    currentStockPrice: currentStockPrice,
                    activeTab: activeTab,
                    earnings: {
                        epsTtm: parseFloat(epsTtmInput.value),
                        growthRate: parseFloat(growthRateInput.value),
                        peMultiple: parseFloat(peMultipleInput.value)
                    },
                    cashFlow: {
                        fcfShare: parseFloat(fcfShareInput.value),
                        fcfGrowthRate: parseFloat(fcfGrowthRateInput.value),
                        fcfYield: parseFloat(fcfYieldInput.value)
                    },
                    desiredReturn: parseFloat(desiredReturnInput.value),
                    results: {
                        returnFromToday: returnFromTodayDisplay ? returnFromTodayDisplay.textContent : 'N/A',
                        entryPrice: entryPriceDisplay ? entryPriceDisplay.textContent : 'N/A',
                        priceAfter5Years: priceAfter5YearsDisplay ? priceAfter5YearsDisplay.textContent : 'N/A'
                    }
                };
            }

            async function populateFormWithCalculationData(data) { 
                clearAllFields();
                tickerInput.value = data.ticker || ''; 

                await fetchAndPopulateMetrics(); 


                currentStockPrice = data.currentStockPrice || currentStockPrice; 
                if (currentStockPriceDisplay) currentStockPriceDisplay.textContent = `$${currentStockPrice.toFixed(2)}`;

                if (data.activeTab === 'earnings') {
                    if (earningsTabBtn) earningsTabBtn.click();
                    if (epsTtmInput) epsTtmInput.value = data.earnings.epsTtm !== undefined ? data.earnings.epsTtm.toFixed(2) : '0.00';
                    if (growthRateInput) growthRateInput.value = data.earnings.growthRate !== undefined ? data.earnings.growthRate : '';
                    if (peMultipleInput) peMultipleInput.value = data.earnings.peMultiple !== undefined ? data.earnings.peMultiple : '';
                } else {
                    if (cashFlowTabBtn) cashFlowTabBtn.click();
                    if (fcfShareInput) fcfShareInput.value = data.cashFlow.fcfShare !== undefined ? data.cashFlow.fcfShare.toFixed(2) : '0.00';
                    if (fcfGrowthRateInput) fcfGrowthRateInput.value = data.cashFlow.fcfGrowthRate !== undefined ? data.cashFlow.fcfGrowthRate : '';
                    if (fcfYieldInput) fcfYieldInput.value = data.cashFlow.fcfYield !== undefined ? data.cashFlow.fcfYield : '';
                }
                if (desiredReturnInput) desiredReturnInput.value = data.desiredReturn !== undefined ? data.desiredReturn : '';


                calculatePriceBtn.click(); 
                showToast('Saved calculation loaded successfully. Click "Calculate" to re-run.', false);
            }

            
            function showConfirmationModal(message, callback) {
                modalMessage.textContent = message;
                modalTitle.textContent = 'Confirm Deletion';
                confirmationModal.classList.remove('hidden');
                modalCallback = callback;
            }

            function hideConfirmationModal() {
                confirmationModal.classList.add('hidden');
                modalCallback = null;
            }

            confirmYesBtn.addEventListener('click', () => {
                if (modalCallback) {
                    modalCallback();
                }
                hideConfirmationModal();
            });

            confirmNoBtn.addEventListener('click', () => {
                hideConfirmationModal();
            });

            async function deleteCalculation(calcId) {
                if (!currentUser) {
                    showToast('You must be logged in to delete calculations.', true);
                    showPage(loginPage);
                    return;
                }

                if (!currentUser.emailVerified && currentUser.providerData[0].providerId === 'password') {
                    showToast('Please verify your email address to delete calculations.', true);
                    return;
                }

                try {
                    const response = await apiCall(`/delete_calculation/${calcId}`, {
                        method: 'DELETE',
                    });

                    const result = await response.json();
                    if (response.ok) {
                        showToast(result.message, false);
                        loadSavedCalculations();
                    } else {
                        showToast(`Error deleting calculation: ${result.message}`, true);
                    }
                } catch (error) {
                    console.error('Delete calculation error:', error);
                    showToast('An error occurred while deleting the calculation.', true);
                }
            }

            
            function showToast(message, isError = false, duration = 3000) {
                const toast = document.createElement('div');
                toast.className = `toast ${isError ? 'error' : 'success'}`;
                // Optional: Add an icon
                const icon = document.createElement('span');
                icon.className = 'toast-icon';
                icon.innerHTML = isError ? '&#x2716;' : '&#x2714;'; 
                toast.appendChild(icon);
                
                const text = document.createElement('span');
                text.textContent = message;
                toast.appendChild(text);

                toastContainer.appendChild(toast);


                setTimeout(() => {
                    toast.style.animation = 'fadeOut 0.5s forwards'; 
                    toast.addEventListener('animationend', () => {
                        toast.remove();
                    });
                }, duration);
            }

            // Add event listeners
            loginBtn.addEventListener('click', handleLogin);
            googleLoginBtn.addEventListener('click', handleGoogleLogin); 
            registerBtn.addEventListener('click', handleRegister);
            getCurrentDataBtn.addEventListener('click', fetchAndPopulateMetrics);
            calculatePriceBtn.addEventListener('click', calculatePrice);
            
            earningsTabBtn.addEventListener('click', () => {
                activeTab = 'earnings';
                earningsTabBtn.classList.add('active');
                cashFlowTabBtn.classList.remove('active');
                earningsSection.classList.remove('hidden');
                cashFlowSection.classList.add('hidden');
            });

            cashFlowTabBtn.addEventListener('click', () => {
                activeTab = 'cashFlow';
                cashFlowTabBtn.classList.add('active');
                earningsTabBtn.classList.remove('active');
                cashFlowSection.classList.remove('hidden');
                earningsSection.classList.add('hidden');
            });
            saveCalculationBtn.addEventListener('click', saveCalculation);
            loadCalculationsBtn.addEventListener('click', loadSavedCalculations);
            
        });
    </script>
</body>
</html>
